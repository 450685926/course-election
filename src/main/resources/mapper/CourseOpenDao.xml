<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.server.edu.election.dao.CourseOpenDao">
  <resultMap id="BaseResultMap" type="com.server.edu.election.entity.CourseOpen">
    <id column="ID_" jdbcType="BIGINT" property="id" />
    <result column="CALENDAR_ID_" jdbcType="BIGINT" property="calendarId" />
    <result column="COURSE_CODE_" jdbcType="VARCHAR" property="courseCode" />
    <result column="COURSE_NAME_" jdbcType="VARCHAR" property="courseName" />
    <result column="COURSE_NAME_EN_" jdbcType="VARCHAR" property="courseNameEn" />
    <result column="IS_ELECTIVE_" jdbcType="INTEGER" property="isElective" />
    <result column="FACULTY_" jdbcType="VARCHAR" property="faculty" />
    <result column="TERM_" jdbcType="VARCHAR" property="term" />
    <result column="CROSS_TERM_" jdbcType="INTEGER" property="crossTerm" />
    <result column="TRAINING_LEVEL_" jdbcType="VARCHAR" property="trainingLevel" />
    <result column="FORM_LEARNING_" jdbcType="VARCHAR" property="formLearning" />
    <result column="NATURE_" jdbcType="VARCHAR" property="nature" />
    
    <result column="PERIOD_" jdbcType="DOUBLE" property="period" />
    <result column="CREDITS_" jdbcType="DOUBLE" property="credits" />
    <result column="NUMBER_" jdbcType="INTEGER" property="number" />
    <result column="IS_OPEN_" jdbcType="INTEGER" property="isOpen" />
    <result column="REMARK_" jdbcType="VARCHAR" property="remark" />
    <result column="CREATED_AT_" jdbcType="TIMESTAMP" property="createdAt" />
    <result column="UPDATED_AT_" jdbcType="TIMESTAMP" property="updatedAt" />
  </resultMap>
  <resultMap id="affinityMap" type="com.server.edu.election.vo.CourseOpenVo" extends="com.server.edu.election.dao.CourseOpenDao.BaseResultMap">
     <result column="courseId" jdbcType="BIGINT" property="courseId" />
     <result column="suggestStatus" jdbcType="INTEGER" property="suggestStatus" />
  </resultMap>
  <select id="selectCourseList" parameterType="com.server.edu.election.entity.CourseOpen" resultMap="affinityMap">
		SELECT
			t1.ID_,
			t2.ID_ courseId,
			t1.COURSE_CODE_,
			t1.COURSE_NAME_,
			t1.COURSE_NAME_EN_,
			t1.TRAINING_LEVEL_,
			t1.CREDITS_,
			t1.FACULTY_
		FROM
			course_open_t t1
		JOIN course_t t2 ON (
			t1.IS_OPEN_ = 1
			AND t1.COURSE_CODE_ = t2.CODE_
		)
		WHERE
			COURSE_CODE_ NOT IN (
				SELECT
					t2.CODE_
				FROM
					course_t t2
				JOIN elc_affinity_courses_t t3 ON t2.ID_ = t3.COURSE_ID_
			)
		<if test="@com.server.edu.util.MybatisUtil@isNotEmpty(courseCode)">
	        and t1.COURSE_CODE_ like concat('%',#{courseCode},'%')
	    </if>
	    <if test="@com.server.edu.util.MybatisUtil@isNotEmpty(courseName)">
	        and t1.COURSE_NAME_ like concat('%',#{courseName},'%')
	    </if> 
  </select>
  <select id="selectCourseSuggestSwitch" parameterType="com.server.edu.election.dto.CourseOpenDto" resultMap="affinityMap">
    SELECT DISTINCT * from (
		SELECT
		    t1.ID_,
			t1.COURSE_CODE_,
			t1.COURSE_NAME_,
			t1.COURSE_NAME_EN_,
			t1.TRAINING_LEVEL_,
			t1.CREDITS_,
			t1.PERIOD_,
		    IFNULL(t2.ID_,0) suggestStatus
		FROM
			course_open_t t1
		LEFT JOIN elc_course_suggest_switch_t t2 ON t1.COURSE_CODE_ = t2.COURSE_CODE_
		<where>
			and t1.IS_OPEN_ = 1
		    <if test="@com.server.edu.util.MybatisUtil@isNotEmpty(calendarId)">
		        and t1.CALENDAR_ID_  = #{calendarId}
		    </if>
		    <if test="@com.server.edu.util.MybatisUtil@isNotEmpty(keyWord)">
		        and (t1.COURSE_CODE_ like concat(#{keyWord},'%') or t1.COURSE_NAME_ like concat(#{keyWord},'%') or t1.COURSE_NAME_EN_ like concat(#{keyWord},'%'))
		    </if>
		    <if test="@com.server.edu.util.MybatisUtil@isNotEmpty(trainingLevel)">
		        and t1.TRAINING_LEVEL_  = #{trainingLevel}
		    </if>
		    <if test="@com.server.edu.util.MybatisUtil@isNotEmpty(faculty)">
		        and t1.FACULTY_  = #{faculty}
		    </if>
		    <if test="@com.server.edu.util.MybatisUtil@isNotEmpty(nature)">
		        and t1.NATURE_  = #{nature}
		    </if>
		    <if test="credits !=null and credits !=0">
		        and t1.CREDITS_  = #{credits}
		    </if>
		    <if test="period !=null and period !=0">
		        and t1.PERIOD_  = #{period}
		    </if>
		    <if test="@com.server.edu.util.MybatisUtil@isNotEmpty(projectId)">
		        and t1.PROJ_ID_  = #{projectId}
		    </if>
			<if test="@com.server.edu.util.MybatisUtil@isNotEmpty(courses)">
		        and t1.COURSE_CODE_ in
		        <foreach item="courseCode" collection="courses" index="index" open="(" separator="," close=")">
		          #{courseCode}
		        </foreach>
		     </if>
		</where>
		)t3 
		<where>
		    <if test="suggestStatus !=null and suggestStatus ==0">
		        and t3.suggestStatus  = 0
		    </if>
		    <if test="suggestStatus !=null and suggestStatus ==1">
		        and t3.suggestStatus  &gt; 0
		    </if>
		</where>
  </select>

	<select id="queryNameAndTrainingLevelByCode" parameterType="java.lang.String" resultMap="BaseResultMap">
		SELECT COURSE_CODE_,COURSE_NAME_,COURSE_NAME_EN_,TRAINING_LEVEL_ FROM course_open_t where COURSE_CODE_ = #{courseCode}
	</select>

	<select id="findFailedCourseInfo" resultType="com.server.edu.election.vo.FailedCourseVo">
		select
			a.CALENDAR_ID_ calendarId,a.IS_OPEN_ isOpen,a.COURSE_CODE_ courseCode,
			a.COURSE_NAME_ courseName, a.TRAINING_LEVEL_ trainingLevel,a.CREDITS_ credits,
			b.NATURE_ nature,b.ASSESSMENT_MODE_ assessmentMode
		from course_open_t a
		join course_t b on b.CODE_ = a.COURSE_CODE_
		where a.COURSE_CODE_ in
		<foreach item="item" collection="courseCodes" separator="," open="(" close=")" >
			#{item}
		</foreach>
		and a.CALENDAR_ID_ = #{calendarId}
	</select>

	<select id="findRebuildCourses" resultType="com.server.edu.election.vo.RebuildCourseVo">
		select
			a.COURSE_NAME_ courseName,a.FACULTY_ faculty,a.CREDITS_ credits,
			c.ID_ teachingClassId,c.CODE_ classCode,c.CAMPUS_ campus,c.REMARK_ remark,
			c.ELC_NUMBER_ selectNumber,c.NUMBER_ number,d.TEACHER_NAME_ teacherName
		from course_open_t a
		join teaching_task_t b on b.COURSE_OPEN_ID_ = a.ID_
		join teaching_class_t c on c.TASK_ID_ = b.ID_
		join teaching_class_teacher_t d on d.TEACHING_CLASS_ID_ = c.ID_
		where a.COURSE_CODE_ in
		<foreach item="item" collection="courseCodes" separator="," open="(" close=")" >
			#{item}
		</foreach>
		and a.CALENDAR_ID_ = #{calendarId}
		<if test="@com.server.edu.util.MybatisUtil@isNotEmpty(keyWord)">
			and (st.STUDENT_CODE_ like CONCAT('%', #{keyWord}, '%') or st.NAME_ like CONCAT('%', #{keyWord}, '%'))
		</if>
	</select>
</mapper>